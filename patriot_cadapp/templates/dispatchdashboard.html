<!DOCTYPE html>
<html>

<head>
    <title>Dispatch Dashboard</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'dos.css' %}">
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        /* Basic styles for the layout */
        .container {
            display: flex; /* Use flexbox for layout */
            justify-content: space-between; /* Space between columns */
            margin: 20px; /* Add some margin */
        }
        .column {
            flex: 1; /* Each column takes equal space */
            margin: 0 10px; /* Add some margin between columns */
        }
        h1 {
            text-align: center; /* Center the headings */
        }
    </style>
</head>

<body>
    <h4 style="color: tomato;">ALPHA VERSION</h4>
    <div class="screen">
        <div class="menubar">
            <div class="menu-item">Navigate
                <div class="menu">
                    <div class="menu-content">
                        <p><a href="/logout" style="color: gray;">Logout</a></p>
                        <p><a href="/" style="color: gray;">Desktop</a></p>
                        <hr />
                    </div>
                </div>
            </div>
            <div class="menu-item">File
                <div class="menu">
                    <div class="menu-content">
                        <p><a href="/idcheck" style="color: gray;">Traffic Citation</a></p>
                        <hr />
                    </div>
                </div>
            </div>
            <div class="menu-item">Help
                <div class="menu">
                    <div class="menu-content">
                        <p class="10-code"><a href="/10codesdispatch" style="color: gray;">10 Codes</a></p>
                        <p class="seven">Administrative Help</p>
                        <p class="six">Training Manuals</p>
                    </div>
                </div>
            </div>
            <div class="menu-item">Dispatch Tools
                <div class="menu">
                    <div class="menu-content">
                        <p class="10-code" style="color: gray;"><a href="/vcheck" style="color: gray;">Check Vehicle Registration</a></p>
                        <p class="10-code" style="color: gray;"><a href="/idcheck" style="color: gray;">License/ID Check</a></p>
                        <p class="10-code" style="color: gray;"><a href="/addcall" style="color: gray;">Start Call</a></p>
                        <p class="six">Reports</p>
                    </div>
                </div>
            </div>

            <div class="menu-item"><img src="{% static 'phone1.png' %}"/>FIRE</div>
            <div class="menu-item"><img src="{% static 'phone1.png' %}"/>EMS</div>
            <div class="menu-item"><img src="{% static 'phone1.png' %}"/>TOW</div>
            <div class="menu-item"><img src="{% static 'phone1.png' %}"/>SUPERVISOR</div>
            <div class="right">
                <div class="menu-item"><a href="/logout" style="color: red;">Logout</a></div>
            </div>
        </div>

        {{loggedUser.badge}} {{loggedUser.last_name}}
        <div class="container">
            <div class="column" id="active-call-log-column">
                <h1>ACTIVE CALL LOG</h1>
                <table id="active-call-log" style="width:100%">
                    <thead>
                        <tr>
                            <th>Location</th>
                            <th>Priority</th> 
                            <th>Description</th>
                            <th>Assigned Officers</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Rows will be populated by AJAX -->
                    </tbody>
                </table>
            </div>
        
            <div class="column" id="active-leo-fire-column">
                <h1>ACTIVE LEO</h1>
                <table id="leo-status-table" style="width:100%">
                    <thead>
                        <tr>
                            <th>UNIT</th>
                            <th>STATUS</th> 
                            <th>AOP</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Rows will be populated by AJAX -->
                    </tbody>
                </table>
        
                <h1>ACTIVE FIRE/EMS</h1>
                <table style="width:100%">
                    <tr>
                        <th>UNIT</th>
                        <th>STATUS</th> 
                        <th>AOP</th>
                        <th>Actions</th>
                    </tr>
                    {% for f in fire %}
                    {% if f.status == "10-8" %}
                    <tr style="background-color: green;">
                        <td>{{f.badge}}, {{f.last_name}}</td>
                        <td><a href="status/{{f.id}}">{{f.status}}</a></td>
                        <td>AVAILIBLE</td>
                        <td><a href="#" style="color: grey;">View</a>|<a href="#" style="color: grey;">Attach</a></td>
                    </tr>
                    {% elif f.status == "10-6" %}
                    <tr style="background-color: yellow;">
                        <td>{{f.badge}}, {{f.last_name}}</td>
                        <td><a href="status/{{f.id}}">{{f.status}}</a></td>
                        <td>BREAK</td>
                        <td><a href="#" style="color: grey;">View</a>|<a href="#" style="color: grey;">Attach</a></td>
                    </tr>
                    {% elif f.status == "10-7" %}
                    <tr style="background-color: gray;">
                        <td>{{f.badge}}, {{f.last_name}}</td>
                        <td><a href="status/{{f.id}}">{{f.status}}</a></td>
                        <td>UNAVAILIBLE</td>
                        <td><a href="#" style="color: grey;">View</a>|<a href="#" style="color: grey;">Attach</a></td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </table>
            </div>
        </div>

        <div class="footer">
            <p>&lt;Shift+F1=Help&gt; &lt;F6=Window&gt; &lt;F2=Subs&gt; &lt;F8=Step&gt;</p>
        </div>
    </div>

    <!-- Inline JavaScript for AJAX -->
    <script>
        const assignOfficerUrl = "{% url 'assign_officer' 0 %}".replace(/0$/, ''); // Base URL for assigning officer
    
        function fetchUserStatus() {
            $.ajax({
                url: "{% url 'get_leo' %}",  // Updated to use the new get_leo view
                method: "GET",
                success: function(data) {
                    // Update the dashboard with the new data
                    let tableBody = $('#leo-status-table tbody'); // Assuming you have a table with this ID
                    tableBody.empty(); // Clear existing rows but keep the headers
                    data.forEach(function(officer) {
                        let statusColor;
                        if (officer.status === "10-8") {
                            statusColor = "green";
                        } else if (officer.status === "10-6") {
                            statusColor = "yellow";
                        } else if (officer.status === "10-7") {
                            statusColor = "gray";
                        }
                        let row = `<tr style="background-color: ${statusColor};">
                            <td>${officer.badge}, ${officer.last_name}</td>
                            <td><a href="statusdispatch/${officer.id}" style="text-decoration: none;">${officer.status}</a></td>
                            <td>${officer.status === "10-8" ? "AVAILIBLE" : (officer.status === "10-6" ? "BREAK" : "UNAVAILIBLE")}</td>
                        </tr>`;
                        tableBody.append(row);
                    });
                }
            });
        }
    
        function fetchActiveCalls() {
            $.ajax({
                url: "{% url 'get_calls' %}",  // Update to use the new get_active_calls view
                method: "GET",
                success: function(data) {
                    // Update the dashboard with the new data
                    let tableBody = $('#active-call-log tbody'); // Assuming you have a table with this ID
                    tableBody.empty(); // Clear existing rows
                    data.forEach(function(call) {
                        let priorityColor;
                        if (call.code == 1) {
                            priorityColor = "red";
                        } else if (call.code == 2) {
                            priorityColor = "yellow";
                        } else if (call.code == 3) {
                            priorityColor = "green";
                        }
                        let row = `<tr style="background-color: ${priorityColor};">
                            <td>${call.location}</td>
                            <td>${call.code}</td>
                            <td>${call.description}</td>
                            <td>
                                ${call.assigned_officers.map(officer => `${officer.badge} ${officer.last_name}`).join(', ')}
                            </td>
                            <td>
                                <a href="/viewlog/${call.id}" style="color:gray;">View</a> |
                                <a href="clearcall/${call.id}" style="color:gray;">Clear</a> |
                                <a href="editcall/${call.id}" style="color:gray;">Edit</a> |
                                <a href="${assignOfficerUrl}${call.id}/" style="color:gray;">Assign Officer</a>
                            </td>
                        </tr>`;
                        tableBody.append(row);
                    });
                }
            });
        }
    
        // Fetch user status and active calls when the page loads
        $(document).ready(function() {
            fetchUserStatus();
            fetchActiveCalls();
            // Fetch user status and active calls every 5 seconds
            setInterval(fetchUserStatus, 5000);
            setInterval(fetchActiveCalls, 5000);
        });
    </script>

</body>

</html>